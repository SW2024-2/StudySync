<body id="goal-page">
  <!-- レポートに戻るリンク -->
  <div class="back-to-report">
  <%= link_to 'レポートに戻る', reports_path, class: 'back-link' %>

  </div>

  <h1>目標</h1>

  <!-- タブ -->
  <div class="tabs">
    <button id="today-goals-tab" class="tab-button active">今日の目標</button>
    <button id="this-week-goals-tab" class="tab-button">今週の目標</button>
    <button id="this-month-goals-tab" class="tab-button">今月の目標</button>
  </div>

  <!-- 今日の目標 -->
  <div id="today-goals" class="goal-section">
    <h2>今日の目標</h2>
    <% if @todays_goals.blank? %>
      <p class="no-goals">
        今日の目標が設定されていません。
        <%= link_to '目標を設定する', new_report_goal_path(report_id: @report.id), class: 'setup-goal-link' %>
      </p>
    <% else %>
      <% @todays_goals.each do |goal| %>
        <div class="goal-card">
          <h3><%= goal.title %></h3>
          <p><strong>学習時間:</strong> <%= goal.study_time %>分</p>
          <p><strong>進捗度:</strong> <%= goal.progress_percentage.round(2) %>%</p>
          <div class="progress-chart">
            <canvas id="progressChart-<%= goal.id %>"></canvas>
          </div>
          <div class="goal-actions">
            <%= link_to '編集', edit_report_goal_path(@report, goal), class: 'edit-link' %> |
            <%= link_to '削除', report_goal_path(@report, goal), method: :delete, data: { confirm: '本当に削除しますか？' }, class: 'delete-link' %>
          </div>
        </div>
      <% end %>
    <% end %>
  </div>

  <!-- 今週の目標 -->
  <div id="this-week-goals" class="goal-section" style="display:none;">
    <h2>今週の目標</h2>
    <% if @this_weeks_goals.blank? %>
      <p class="no-goals">
        今週の目標が設定されていません。
        <%= link_to '目標を設定する', new_report_goal_path(report_id: @report.id), class: 'setup-goal-link' %>
      </p>
    <% else %>
      <% @this_weeks_goals.each do |goal| %>
        <div class="goal-card">
          <h3><%= goal.title %></h3>
          <p><strong>学習時間:</strong> <%= goal.study_time %>分</p>
          <p><strong>進捗度:</strong> <%= goal.progress_percentage.round(2) %>%</p>
          <div class="progress-chart">
            <canvas id="progressChart-week-<%= goal.id %>"></canvas>
          </div>
          <div class="goal-actions">
            <%= link_to '編集', edit_report_goal_path(@report, goal), class: 'edit-link' %> |
            <%= link_to '削除', report_goal_path(@report, goal), method: :delete, data: { confirm: '本当に削除しますか？' }, class: 'delete-link' %>
          </div>
        </div>
      <% end %>
    <% end %>
  </div>

  <!-- 今月の目標 -->
  <div id="this-month-goals" class="goal-section" style="display:none;">
    <h2>今月の目標</h2>
    <% if @this_months_goals.blank? %>
      <p class="no-goals">
        今月の目標が設定されていません。
        <%= link_to '目標を設定する', new_report_goal_path(report_id: @report.id), class: 'setup-goal-link' %>
      </p>
    <% else %>
      <% @this_months_goals.each do |goal| %>
        <div class="goal-card">
          <h3><%= goal.title %></h3>
          <p><strong>学習時間:</strong> <%= goal.study_time %>分</p>
          <p><strong>進捗度:</strong> <%= goal.progress_percentage.round(2) %>%</p>
          <div class="progress-chart">
            <canvas id="progressChart-month-<%= goal.id %>"></canvas>
          </div>
          <div class="goal-actions">
            <%= link_to '編集', edit_report_goal_path(@report, goal), class: 'edit-link' %> |
            <%= link_to '削除', report_goal_path(@report, goal), method: :delete, data: { confirm: '本当に削除しますか？' }, class: 'delete-link' %>
          </div>
        </div>
      <% end %>
    <% end %>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
      // タブのクリックイベント
      document.getElementById('today-goals-tab').addEventListener('click', function() {
        showSection('today-goals');
      });
      document.getElementById('this-week-goals-tab').addEventListener('click', function() {
        showSection('this-week-goals');
      });
      document.getElementById('this-month-goals-tab').addEventListener('click', function() {
        showSection('this-month-goals');
      });
  
      function showSection(sectionId) {
        // すべてのセクションを非表示にする
        document.querySelectorAll('.goal-section').forEach(function(section) {
          section.style.display = 'none';
        });
        // 選択されたセクションを表示する
        document.getElementById(sectionId).style.display = 'block';
        // タブのアクティブ状態を変更
        document.querySelectorAll('.tab-button').forEach(function(tab) {
          tab.classList.remove('active');
        });
        document.getElementById(sectionId + '-tab').classList.add('active');
  
        // 進捗グラフの描画処理をタブ切り替え後に実行
        drawProgressCharts(sectionId);
      }
  
      function drawProgressCharts(sectionId) {
        if (sectionId === 'today-goals') {
          // 今日の目標の進捗グラフ
          <% @todays_goals.each do |goal| %>
            const progressPercentage = <%= [goal.progress_percentage, 100].min %>;
  
            const ctx<%= goal.id %> = document.getElementById('progressChart-<%= goal.id %>').getContext('2d');
            new Chart(ctx<%= goal.id %>, {
              type: 'doughnut',
              data: {
                labels: ['進捗済み', '残り'],
                datasets: [{
                  data: [progressPercentage, 100 - progressPercentage],
                  backgroundColor: ['#4caf50', '#ddd'],
                }]
              },
              options: {
                responsive: true,
                plugins: {
                  legend: { position: 'bottom' },
                  tooltip: { callbacks: { label: ctx => `${ctx.label}: ${ctx.raw}%` } }
                }
              }
            });
          <% end %>
        } else if (sectionId === 'this-week-goals') {
          // 今週の目標の進捗グラフ
          <% @this_weeks_goals.each do |goal| %>
            const progressPercentageWeek = <%= [goal.progress_percentage, 100].min %>;
  
            const ctxWeek<%= goal.id %> = document.getElementById('progressChart-week-<%= goal.id %>').getContext('2d');
            new Chart(ctxWeek<%= goal.id %>, {
              type: 'doughnut',
              data: {
                labels: ['進捗済み', '残り'],
                datasets: [{
                  data: [progressPercentageWeek, 100 - progressPercentageWeek],
                  backgroundColor: ['#4caf50', '#ddd'],
                }]
              },
              options: {
                responsive: true,
                plugins: {
                  legend: { position: 'bottom' },
                  tooltip: { callbacks: { label: ctx => `${ctx.label}: ${ctx.raw}%` } }
                }
              }
            });
          <% end %>
        } else if (sectionId === 'this-month-goals') {
          // 今月の目標の進捗グラフ
          <% @this_months_goals.each do |goal| %>
            const progressPercentageMonth = <%= [goal.progress_percentage, 100].min %>;
  
            const ctxMonth<%= goal.id %> = document.getElementById('progressChart-month-<%= goal.id %>').getContext('2d');
            new Chart(ctxMonth<%= goal.id %>, {
              type: 'doughnut',
              data: {
                labels: ['進捗済み', '残り'],
                datasets: [{
                  data: [progressPercentageMonth, 100 - progressPercentageMonth],
                  backgroundColor: ['#4caf50', '#ddd'],
                }]
              },
              options: {
                responsive: true,
                plugins: {
                  legend: { position: 'bottom' },
                  tooltip: { callbacks: { label: ctx => `${ctx.label}: ${ctx.raw}%` } }
                }
              }
            });
          <% end %>
        }
      }
  
      // 初期表示で今日の目標の進捗グラフを描画
      drawProgressCharts('today-goals');
    });
  </script>

</body>
