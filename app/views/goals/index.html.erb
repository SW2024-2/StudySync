<body id="goal-page">
  <h1>目標</h1>

  <!-- タブ -->
  <div class="tabs">
    <button id="today-goals-tab" class="tab-button active">今日の目標</button>
    <button id="this-week-goals-tab" class="tab-button">今週の目標</button>
    <button id="this-month-goals-tab" class="tab-button">今月の目標</button>
  </div>

  <!-- 今日の目標 -->
<div id="today-goals" class="goal-section">
  <h2>今日の目標</h2>
  <% if @todays_goals.blank? %>
    <p class="no-goals">今日の目標が設定されていません。<%= link_to '目標を設定する', new_goal_path, class: 'setup-goal-link' %></p>
  <% else %>
    <% @todays_goals.each do |goal| %>
      <div class="goal-card">
        <h3><%= goal.title %></h3>
        <p><strong>学習時間:</strong> <%= goal.study_time %>分</p>
        <p><strong>進捗度:</strong> <%= goal.progress_percentage.round(2) %>%</p>
        <div class="progress-chart">
          <canvas id="progressChart-<%= goal.id %>"></canvas>
        </div>
        <div class="goal-actions">
          <%= link_to '編集', edit_goal_path(goal), class: 'edit-link' %> |
          <%= link_to '削除', goal_path(goal), method: :delete, data: { confirm: '本当に削除しますか？' }, class: 'delete-link' %>
        </div>
      </div>
    <% end %>
  <% end %>
</div>

<!-- 今週の目標 -->
<div id="this-week-goals" class="goal-section" style="display:none;">
  <h2>今週の目標</h2>
  <% if @this_weeks_goals.blank? %>
    <p class="no-goals">今週の目標が設定されていません。<%= link_to '目標を設定する', new_goal_path, class: 'setup-goal-link' %></p>
  <% else %>
    <% @this_weeks_goals.each do |goal| %>
      <div class="goal-card">
        <h3><%= goal.title %></h3>
        <p><strong>学習時間:</strong> <%= goal.study_time %>分</p>
        <p><strong>進捗度:</strong> <%= goal.progress_percentage.round(2) %>%</p>
        <div class="progress-chart">
          <canvas id="progressChart-<%= goal.id %>"></canvas>
        </div>
        <div class="goal-actions">
          <%= link_to '編集', edit_goal_path(goal), class: 'edit-link' %> |
          <%= link_to '削除', goal_path(goal), method: :delete, data: { confirm: '本当に削除しますか？' }, class: 'delete-link' %>
        </div>
      </div>
    <% end %>
  <% end %>
</div>

<!-- 今月の目標 -->
<div id="this-month-goals" class="goal-section" style="display:none;">
  <h2>今月の目標</h2>
  <% if @this_months_goals.blank? %>
    <p class="no-goals">今月の目標が設定されていません。<%= link_to '目標を設定する', new_goal_path, class: 'setup-goal-link' %></p>
  <% else %>
    <% @this_months_goals.each do |goal| %>
      <div class="goal-card">
        <h3><%= goal.title %></h3>
        <p><strong>学習時間:</strong> <%= goal.study_time %>分</p>
        <p><strong>進捗度:</strong> <%= goal.progress_percentage.round(2) %>%</p>
        <div class="progress-chart">
          <canvas id="progressChart-<%= goal.id %>"></canvas>
        </div>
        <div class="goal-actions">
          <%= link_to '編集', edit_goal_path(goal), class: 'edit-link' %> |
          <%= link_to '削除', goal_path(goal), method: :delete, data: { confirm: '本当に削除しますか？' }, class: 'delete-link' %>
        </div>
      </div>
    <% end %>
  <% end %>
</div>

</body>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    // 各タブのクリックイベント
    document.getElementById('today-goals-tab').addEventListener('click', function() {
      showSection('today-goals');
    });
    document.getElementById('this-week-goals-tab').addEventListener('click', function() {
      showSection('this-week-goals');
    });
    document.getElementById('this-month-goals-tab').addEventListener('click', function() {
      showSection('this-month-goals');
    });

    function showSection(sectionId) {
      // すべてのセクションを非表示に
      document.querySelectorAll('.goal-section').forEach(function(section) {
        section.style.display = 'none';
      });
      
      // 該当するセクションを表示
      document.getElementById(sectionId).style.display = 'block';
      
      // すべてのタブのアクティブクラスを外し、クリックされたタブにアクティブクラスを追加
      document.querySelectorAll('.tab-button').forEach(function(tab) {
        tab.classList.remove('active');
      });
      
      document.getElementById(sectionId + '-tab').classList.add('active');
    }

    // グラフ描画
    <% @todays_goals.each do |goal| %>
      const ctx<%= goal.id %> = document.getElementById('progressChart-<%= goal.id %>').getContext('2d');
      const progressPercentage<%= goal.id %> = <%= goal.progress_percentage %>;

      new Chart(ctx<%= goal.id %>, {
        type: 'doughnut',
        data: {
          labels: ['進捗済み', '残り'],
          datasets: [{
            data: [progressPercentage<%= goal.id %>, 100 - progressPercentage<%= goal.id %>],
            backgroundColor: ['#4caf50', '#ddd'],
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom' },
            tooltip: { callbacks: { label: ctx => `${ctx.label}: ${ctx.raw}%` } }
          }
        }
      });
    <% end %>
  });
</script>
